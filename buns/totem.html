<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, user-scalable=no">
  	<title>totem</title>
	<style>
body { margin: 0; color: #eee;
background:#333;
font-family: monospace;
font-size: 2em;
user-select:none;}
#cnv {
position: absolute;
top: 0; left: 0;
width: 100%; height: 100% }
#buntex, #middlebun, #topbun, #fourthbun {
position: absolute;	left:0;
}
#middlebun {top: 130px;}
#topbun {top: 260px;}
#buntexcol, #middlebuncol, #topbuncol, #fourthbuncol {
position: absolute;	left:258px; }
#middlebuncol {top: 130px;}
#topbuncol {top: 260px;}
#fourthbun, #fourthbuncol {top: 390px;}
button {padding: 1em;}
#xvar {position: absolute; top: 0; left: 0;
z-index: 99; margin: 0;}
#buntex, #middlebun, #topbun, #fourthbun,
#buntexcol, #middlebuncol, #topbuncol, #fourthbuncol, #fifthbun, #fifthbuncol {visibility: hidden;}

</style>
</head>
<body>


<script src="three.min.js"></script>
<script src="OrbitControls.min.js"></script>
<script>
var t = 0;
var newz = 0;
var newv = 0;
var newt = 0;
var v2v = 0;
var vv = 0;
var vx = 0;
var vz = 0;




// globals
var eyesscale = 0;
var idlestate = true;
var walkstate = false;
var num = 0;
var cosnum = 0;
var sinnum = 0;
var lerpsin = 0;
var lerpcos = 0;
var xnum = 0;
var ynum = 0;
var znum = 0;
// images
const imageURL = [
"buntex.png",
"leg1.png",
"face1col.png",
"grid.png",
"face2col.png",
"face3col.png",
"bunbasetex.png",
"legcol.png",
"face1bmp.png",
"face2bmp.png",
"face3bmp.png",
"bunseeds.png",
"bunseedsbmp.png",
"face1shade.png",
"shade.png",
"baseshade.png"
];



const images = [];
var imageCount = 0;


// add images to loaded func
imageURL.forEach(src => { 
     const image = new Image();
     image.src = src;
     image.onload = ()=>{ 
         imageCount += 1;
         if(imageCount === imageURL.length){ 
             ready();
         }
     }
     images.push(image); 
});	

// once images are loaded, fill canvases
function ready() {
	createcanvas("buntex", images[2], 1.1, 30, images[8]);
	createcanvas("middlebun", images[4], 1, 20, images[9]);
	createcanvas("topbun", images[5], 1.1, 0, images[10]);
	createcanvas("fourthbun", images[5], 1.1, -10, images[10]);
	createcanvas("fifthbun", images[4], 1.1, -20, images[10]);
	init();
	animate();
} // ready


// create bump texture
function createcanvas(name, face, smultiplier, ypos, bmpface){
	// bump canvas
	thisbmp = document.createElement('canvas');
	bmptx = thisbmp.getContext('2d');
	thisbmp.id = name;
	thisbmp.width = 256;
	thisbmp.height = 128;
	// base bun bump texture
	bmptx.fillRect(0, 0, 256, 128);// base black
	bmptx.drawImage(images[0], 0, ypos, 256, 128*smultiplier);// rounded shape

	bmptx.drawImage(bmpface, 112, 50+(ypos/2), 32, 32);// face

	// colour canvas
	thiscol = document.createElement('canvas');
	coltx = thiscol.getContext('2d');
	thiscol.id = name+'col';
	thiscol.width = 256;
	thiscol.height = 128;	
	// coltx.fillRect(0, 0, 256, 128);// base black
	coltx.drawImage(images[6], 0, 0, 256, 128);//base col
	coltx.drawImage(face, 112, 50+(ypos/2), 32, 32);// face

	// do it all
	document.body.appendChild(thisbmp);	
	document.body.appendChild(thiscol);	

}


// events
window.addEventListener( 'resize', onWindowResize, false );
// resize event
function onWindowResize() {
camera.aspect = window.innerWidth / window.innerHeight;
camera.updateProjectionMatrix();
renderer.setSize( window.innerWidth, window.innerHeight );
}


// initiaise three.js
function init(){
	scene = new THREE.Scene();
	camera = new THREE.PerspectiveCamera( 75, window.innerWidth/window.innerHeight, 0.1, 1000 );

	renderer = new THREE.WebGLRenderer({
    	alpha: true,
    	antialias: true
  	});

	renderer.setSize( window.innerWidth, window.innerHeight );
	renderer.domElement.id = 'cnv';
	document.body.appendChild( renderer.domElement );

	camera.position.x = 50;
	camera.position.z = 20;

	// controls
	controls = new THREE.OrbitControls(camera, renderer.domElement);
	controls.enablePan = false;
	controls.enableDamping = true;
	controls.dampingFactor = 0.9;
	controls.maxDistance = 300;
	controls.minDistance = 10;

	// groups
	hero = new THREE.Group();
	hero.position.y = -10;
	scene.add(hero);


	// light
	var light = new THREE.AmbientLight( 0x333333 );
	light.intensity = 0.1;
	scene.add( light );

	// backlight
	var directionalLight = new THREE.DirectionalLight( 0xcccccc, 0.0005 );
	directionalLight.position.set(0,2000,100)
	directionalLight.rotation.set(-Math.PI/2,0,0)
	scene.add( directionalLight );

	// bun base texture
	var bumpcnv = new THREE.CanvasTexture(buntex);

	bumpcnv.wrapS = THREE.RepeatWrapping;
	bumpcnv.wrapT = THREE.RepeatWrapping;

	// sphere face 
	var geometry = new THREE.SphereBufferGeometry( 10, 500, 500 );
	var material = new THREE.MeshStandardMaterial( { 
	color: 0xfc0065,
	  // metalness: 20,
	  roughness: 100,
	  map : bumpcnv,
	  displacementMap: bumpcnv,
	  displacementScale: 20
	  } );

	// create buns
	modelstore = [];
	//
	createbun("bbmp", buntex, buntexcol);
	createbun("mbmp", middlebun, middlebuncol);
	createbun("tbmp", topbun, topbuncol);
	createbun("ttbmp", fourthbun, fourthbuncol);
	createbun("t5bmp", fifthbun, fifthbuncol);


	// set each bun

	// bottom bun
	modelstore[0].position.y = 0;
	modelstore[0].scale.set(1,0.5,1);
	modelstore[0].material.color = {r:246, g:206, b:204};

	// middle bun
	modelstore[1].position.y = 9.5;
	modelstore[1].scale.set(0.8,0.5,0.8);
	modelstore[1].material.color = {r:231, g:186, b:219};

	// top bun
	modelstore[2].position.y = 18;
	modelstore[2].scale.set(0.6,0.5,0.6);
	modelstore[2].material.color = {r:206, g:250, b:155};

	// fourthbun
	modelstore[3].position.y = 26;
	modelstore[3].scale.set(0.5,0.4,0.5);
	modelstore[3].material.color = {r:255, g:250, b:255};


	// fifthbun
	modelstore[4].position.y = 33;
	modelstore[4].scale.set(0.35,0.35,0.35);
	modelstore[4].material.color = {r:255, g:250, b:150};

// 
modelstore.forEach(model => { 
model.material.map.minFilter = model.material.map.magFilter = THREE.NearestFilter;	
});	


} // end init


// create bun
function createbun(objname, texname, colname){
		// sphere 
		var geometry = new THREE.SphereBufferGeometry( 10, 200, 200 );
		var material = new THREE.MeshStandardMaterial( { 
		color: 0xfc0065,
		metalness: 0.6,
		map : new THREE.CanvasTexture(texname),
		map : new THREE.CanvasTexture(colname),
		displacementMap: new THREE.CanvasTexture(texname),
		displacementScale: 10
		} );
		
		//
		var bunobj = new THREE.Mesh( geometry, material );
		bunobj.name = objname;
		hero.add( bunobj );
		modelstore.push(bunobj);
}

// render loop
var animate = function () {
	requestAnimationFrame( animate );
	renderer.render( scene, camera );
};
</script>
</body>
</html>