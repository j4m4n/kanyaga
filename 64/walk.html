<html>
    <head>
        <title>dunes</title>
        <link rel="stylesheet" href="css/page.css" />
        <script src="js/three.min.js"></script>
        <script src="js/nipplejs.js"></script>
        <script src="js/utils/math.js"></script>
        <script src="js/classes/Game.js"></script>
        <script src="js/classes/SceneTransition.js"></script>
        <script src="js/classes/Ease.js"></script>
        <script src="js/classes/GoldSmashMinigame.js"></script>
        <script src="js/classes/CrappyObjectInstance.js"></script>
        <!-- <script src="js/utils/sceneLogger.js"></script> -->
        <script src="js/utils/jsonGeoGenerator.js"></script>
        <script src="js/utils/image_parser.js"></script>
        <style>
            #hitcanvas {
                background-color: red;
                position: absolute;
                z-index: 10;
                bottom: 4px;
                left: 4px;
                transform: scale(0.2);
                transform-origin: bottom left;
            }
        </style>
        <img
            src="assets/terrain/natron_bump.png"
            id="natronBumpImg"
            style="display: none"
        />
        <img
            src="assets/terrain/natron_color.png"
            id="natronColorImg"
            style="display: none"
        />
        <img
            src="assets/terrain/hit.png"
            id="natronHit"
            style="display: none"
        />
        <img
            src="assets/terrain/atoll_bump.png"
            id="atollBumpImg"
            style="display: none"
        />
        <img
            src="assets/terrain/atoll_color.png"
            id="atollColorImg"
            style="display: none"
        />
        <img
            src="assets/terrain/crab_bump.png"
            id="crabBumpImg"
            style="display: none"
        />
        <img
            src="assets/terrain/crab_color.png"
            id="crabColorImg"
            style="display: none"
        />
        <img
            src="assets/terrain/flower_bump.png"
            id="flowerBumpImg"
            style="display: none"
        />
        <img
            src="assets/terrain/flower_color.png"
            id="flowerColorImg"
            style="display: none"
        />

        <img
            src="assets/treeBark_35x150.png"
            id="barkImg"
            style="display: none"
        />
        <img src="assets/face.png" id="heroFaceImg" style="display: none" />
        <img
            src="assets/leg-walk3.png"
            id="heroLegWalkImg"
            style="display: none"
        />
        <img
            src="assets/leg-still3.png"
            id="heroLegIdleImg"
            style="display: none"
        />
    </head>

    <body>
        <canvas id="game-canvas"></canvas>
        <div id="joystick-overlay"></div>
    </body>
</html>
<script src="js/globals/MODELS_CONFIG.js"></script>
<script src="js/globals/TREE_TYPES.js"></script>
<script src="js/globals/CONTROLS.js"></script>
<script type="text/javascript">
    // I added an image in the html with id natronHit
    // all code is mine until GAME
    let hitCanvas;
    let hitCtx;
    var imgx = document.getElementById("natronHit");

    function initHit() {
        hitCanvas = document.createElement("canvas");
        hitCanvas.id = "hitcanvas";
        hitCanvas.width = 1024;
        hitCanvas.height = 1024;
        hitCtx = hitCanvas.getContext("2d");
        hitCtx.drawImage(imgx, 0, 0, 1024, 1024);
        document.body.appendChild(hitCanvas);
    }

    function updateHitcanvas(posx, posz) {
        let uv = {
            u: posx / 256 / 2 + 0.5,
            v: posz / 256 / 2 + 0.5,
        };

        // remove this when it works
        hitCtx.drawImage(imgx, 0, 0, 1024, 1024);

        // get colour
        const pixel = hitCtx.getImageData(
            uv.u * hitCanvas.width,
            uv.v * hitCanvas.height,
            1,
            1,
        );

        // the value we need
        console.log(pixel.data[0]);

        // check place on map (remove this later)
        hitCtx.strokeStyle = "#ffff00";
        hitCtx.lineWidth = 4;
        hitCtx.beginPath();
        hitCtx.rect(uv.u * hitCanvas.width, uv.v * hitCanvas.height, 20, 20);
        hitCtx.stroke();
    }

    // this is as is
    let GAME;
    let TIME = 0;

    window.onload = () => {
        initHit();
        console.log("barkImg.width:", barkImg.width);
        console.log("barkImg.height:", barkImg.height);
        initTreeMaterials(barkImg);

        GAME = new Game({
            canvas: document.getElementById("game-canvas"),
            width: 64,
            height: 64,
            mapWidth: 1024,
            mapHeight: 1024,
            currentMapName: "Natron",
            displacementBias: 0,
            maps: {
                Natron: {
                    mapImg: document.getElementById("natronColorImg"),
                    displacementMapImg:
                        document.getElementById("natronBumpImg"),
                    hitMapImg: document.getElementById("natronHit"),
                    waterLevel: 80,
                    displacementScale: 100,
                    houses: [
                        { x: -260, z: -260, modelJsonObj: MODELS_CONFIG.house },
                    ],
                    trees: [
                        {
                            x: 70,
                            z: 160,
                            modelJsonObj: MODELS_CONFIG.tree_Alder_5,
                        },
                        {
                            x: -120,
                            z: -200,
                            modelJsonObj: MODELS_CONFIG.tree_Ash_2,
                        },
                        {
                            x: 180,
                            z: 300,
                            modelJsonObj: MODELS_CONFIG.tree_Aspen_7,
                        },
                        {
                            x: -340,
                            z: 240,
                            modelJsonObj: MODELS_CONFIG.tree_DogRose_1,
                        },
                        {
                            x: 260,
                            z: -320,
                            modelJsonObj: MODELS_CONFIG.tree_DownyBirch_9,
                        },
                        {
                            x: -480,
                            z: 420,
                            modelJsonObj: MODELS_CONFIG.tree_EnglishElm_3,
                        },
                        {
                            x: 390,
                            z: -150,
                            modelJsonObj: MODELS_CONFIG.tree_Hazel_6,
                        },
                        {
                            x: -600,
                            z: -380,
                            modelJsonObj: MODELS_CONFIG.tree_Holly_0,
                        },
                        {
                            x: 540,
                            z: 120,
                            modelJsonObj: MODELS_CONFIG.tree_Hornbeam_4,
                        },
                        {
                            x: 620,
                            z: -220,
                            modelJsonObj: MODELS_CONFIG.tree_LombardyPoplar_8,
                        },
                        {
                            x: -720,
                            z: 520,
                            modelJsonObj: MODELS_CONFIG.tree_Magnolia_5,
                        },
                        {
                            x: 360,
                            z: -480,
                            modelJsonObj: MODELS_CONFIG.tree_MountainAsh_7,
                        },
                        {
                            x: -200,
                            z: -560,
                            modelJsonObj: MODELS_CONFIG.tree_SweetChestnut_2,
                        },
                        {
                            x: 480,
                            z: 600,
                            modelJsonObj: MODELS_CONFIG.tree_Sycamore_9,
                        },
                        {
                            x: -820,
                            z: -300,
                            modelJsonObj: MODELS_CONFIG.tree_TurkeyOak_1,
                        },
                    ],
                },
                Atoll: {
                    mapImg: document.getElementById("atollColorImg"),
                    displacementMapImg: document.getElementById("atollBumpImg"),
                    waterLevel: 180,
                    displacementScale: 200,
                },
                Crab: {
                    mapImg: document.getElementById("crabColorImg"),
                    displacementMapImg: document.getElementById("crabBumpImg"),
                    waterLevel: 550,
                    displacementScale: 400,
                },
                Flower: {
                    mapImg: document.getElementById("flowerColorImg"),
                    displacementMapImg:
                        document.getElementById("flowerBumpImg"),
                    waterLevel: 80,
                    displacementScale: 200,
                },
            },
            player: {
                width: 128,
                size: 32,
                count: 4,
                fps: 16,
                x: 0,
                z: 0,
                xlerp: 0,
                zlerp: 0,
                vx: 0,
                vy: 0,
                xu: 0,
                xv: 0,
                rotation: 0,
                maxSpeed: 0.4,
                moving: false,
            },
            keyboard: CONTROLS.keyboard,
            joystick: CONTROLS.joystick,
            camOffsetY: 0,
            treeScale: 12,
            minigames: {
                0: { name: "goldsmash", handlerClass: GoldSmashMinigame },
            },
        });

        if (typeof DEBUG_UI !== "undefined") {
            DEBUG_UI.init();
        }

        animate();
    };
    function animate() {
        requestAnimationFrame(animate);
        TIME = window.performance.now() * 0.001; // time since game start in seconds
        GAME.update(TIME);
        updateHitcanvas(GAME.player.x, GAME.player.z);
        // console.log(updateHitstate(GAME.player.x, GAME.player.z));
    }
    // setTimeout(() => {
    //     sceneLogger(GAME.scene, "New Scene");
    // }, 500);
</script>
<link rel="stylesheet" href="css/debug.css" />
<!-- <script src="js/globals/DEBUG_UI.js"></script> -->
